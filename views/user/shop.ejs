<!-- User navbar -->
<%-include("../userpartials/Navbar.ejs")%>

    <head>
        <!-- Custom css -->
        <style>
            :root {
                --primary-color: #50c878;
                --secondary-color: #f0ffff;
                --third-color: #1b1b1b;
                --fourth-color: #f82b50;
                --fifth-color: #38ed77;
                --sixth-color: #e4e4e4;
                --offerprice-color: #22a751;
                --realprice-color: #be2626;
            }

            .filter-container {
                position: relative;
            }

            .filter-header {
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: var(--third-color);
                color: #fff;
                padding: 10px 20px;
                cursor: pointer;
            }

            .filter-list {
                position: absolute;
                top: calc(100% + 5px);
                left: 40%;
                z-index: 1000;
                padding: 10px;
                display: none;
            }

            .filter-list.open {
                display: block;
            }

            .filter-toggle-btn{
                background-color: #28a74600;
                border: 0;
                margin-left: 10px;
            }

            .product-outline{
                text-decoration: none;
            }
    
            .product-card:hover {
                transform: scale(1.02);
                transition: 0.5s;
                .product-image{
                    transition: 0.5s;
                    transform: scale(1.05);
                }
            }

            .product-card:not(:hover) {
                transform: scale(1);
                transition: 0.5s;
                .product-image{
                    transition: 0.5s;
                    transform: scale(1);
                }
            }

            .product-name{
                color: var(--third-color);
            }

            .wish-btn{
                color: var(--primary-color);
                font-size: 20px;
            }

            .badge{
                background-color: var(--primary-color);
            }

            .offer-price{
                color: var(--offerprice-color);
            }

            .real-price{
                color: var(--realprice-color);
            }

        </style>
    </head>

    <section class="view">
        <!-- Filter navbar for small screen start -->
        <div class="filter-container mt-4 d-md-none d-block dropdown">
            <div class="filter-header">
                <span>Apply filters</span>
                <button class="filter-toggle-btn dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false"><i class="fa-solid fa-angle-down" style="color: #ffffff;"></i></button>
            </div> 
            <ul class="filter-list dropdown-menu" style="width: 200px;">
                <div class="p-3">
                    <h6 class="font-weight-semi-bold mb-4">Filter by Price</h6>
                    <form>
                        <div
                            class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                            <input type="checkbox" class="custom-control-input" id="price-all">
                            <label class="custom-control-label small" for="price-all"> All Price</label>
                        </div>
                        <div
                            class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                            <input type="checkbox" class="custom-control-input" id="price-1">
                            <label class="custom-control-label small" for="price-1"> ₹0 - ₹20000</label>
                        </div>
                        <div
                            class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                            <input type="checkbox" class="custom-control-input" id="price-2">
                            <label class="custom-control-label small" for="price-2"> ₹20000 - ₹30000</label>
                        </div>
                        <div
                            class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                            <input type="checkbox" class="custom-control-input" id="price-3">
                            <label class="custom-control-label small" for="price-3"> ₹30000 - ₹40000</label>
                        </div>
                        <div
                            class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                            <input type="checkbox" class="custom-control-input" id="price-4">
                            <label class="custom-control-label small" for="price-4"> ₹40000 - ₹50000</label>
                        </div>
                        <div
                            class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                            <input type="checkbox" class="custom-control-input" id="price-4">
                            <label class="custom-control-label small" for="price-4"> ₹50000 - ₹60000</label>
                        </div>
                        <div
                            class="custom-control custom-checkbox d-flex align-items-center justify-content-between">
                            <input type="checkbox" class="custom-control-input" id="price-5">
                            <label class="custom-control-label small" for="price-5"> ₹60000 - Above</label>
                        </div>
                    </form>
                </div>
            </ul>
        </div>
        <!--  Filter navbar for small screen end -->

       

        <!-- Brand carousel start -->
        <div id="carouselExampleAutoplaying" class="carousel slide mt-md-4 mt-0" data-bs-ride="carousel">
            <div class="carousel-inner">
              <% if(adCarousel !="" ){ %>
                <% adCarousel.forEach((adc, index)=> { %>
                  <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
                    <img src="/static/images/AdCarousels/<%= adc.image %>" class="d-block w-100" alt="...">
                  </div>
                <% }); %>
              <% } else { %>
                <div class="carousel-item">
                  <img src="/static/images/AdCarousels/Ad banner 7.jpg" class="d-block w-100" alt="...">
                </div>
              <% } %>
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleAutoplaying"
              data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleAutoplaying"
              data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Next</span>
            </button>
          </div>
        <!-- Brand carousel end -->

        <!-- Shop Start -->
        <div class="container-fluid pt-5">
            <div class="row px-xl-5">
                <!-- Shop Sidebar Start -->
                <div class="col-md-2 d-none d-md-block">
                    <h5 class="font-weight-semi-bold mb-4">Apply filters</h5>
                    <!-- Price Start -->
                    <div class="border-bottom mb-4 pb-4">
                        <h6 class="font-weight-semi-bold mb-4">Filter by Price</h6>
                        <form>
                            <div
                                class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                                <input type="checkbox" class="custom-control-input" id="price-1">
                                <label class="custom-control-label" for="price-1">₹0 - ₹20000</label>
                            </div>
                            <div
                                class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                                <input type="checkbox" class="custom-control-input" id="price-2">
                                <label class="custom-control-label" for="price-2">₹20000 - ₹40000</label>
                            </div>
                            <div
                                class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                                <input type="checkbox" class="custom-control-input" id="price-3">
                                <label class="custom-control-label" for="price-3">₹40000 - ₹60000</label>
                            </div>
                            <div
                                class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                                <input type="checkbox" class="custom-control-input" id="price-4">
                                <label class="custom-control-label" for="price-4">₹60000 - ₹80000</label>
                            </div>
                            <div
                                class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                                <input type="checkbox" class="custom-control-input" id="price-4">
                                <label class="custom-control-label" for="price-4">₹80000 - Above</label>
                            </div>
                        </form>
                    </div>
                    <!-- Price End -->

                    <!-- Category Start -->
                    <% if(category && category.length >0 ){ %>
                    <div class="border-bottom mb-4 pb-4">
                        <h6 class="font-weight-semi-bold mb-4">Filter by Category</h6>
                        
                            <% for(let i = 0; i < category.length; i++){ %>
                            <div class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                                <input type="checkbox" class="custom-control-input" id="<%= category[i]._id %>" data-category-id="<%= category[i]._id %>" onchange="handleCheckboxChange(this)" <% if (categoryId.includes(category[i]._id)) { %> checked <% } %>>
                                <label class="custom-control-label" for="allCategory"><%= category[i].name %></label>
                            </div>
                            <% } %>
                        
                    </div>
                    <% } %>
                    <!-- Category End -->

                    <!-- Brand Start -->
                    <% if(brand && brand.length >0 ){ %>
                        <div class="border-bottom mb-4 pb-4">
                            <h6 class="font-weight-semi-bold mb-4">Filter by Brand</h6>
                            <form>
                                <% for(let i = 0; i < brand.length; i++){ %>
                                <div class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                                    <input type="checkbox" class="custom-control-input" id="<%= brand[i]._id %>" data-brand-id="<%= brand[i]._id %>" onchange="handleCheckboxChange(this)" <% if (brandId.includes(brand[i]._id)) { %> checked <% } %>>
                                    <label class="custom-control-label" for="allCategory"><%= brand[i].name %></label>
                                </div>
                                <% } %>
                            </form>
                        </div>
                    <% } %>
                    <!-- Brand End -->

                    <!-- Sorting Start -->
                    <div class="border-bottom mb-4 pb-4">
                        <h6 class="font-weight-semi-bold mb-4">Sort by price</h6>
                        <form>
                            <div
                                class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                                <input type="radio" class="custom-control-input" id="price-HighToLow">
                                <label class="custom-control-label" for="price-HighToLow">High - Low</label>
                            </div>
                            <div
                                class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                                <input type="radio" class="custom-control-input" id="price-LowToHigh">
                                <label class="custom-control-label" for="price-LowToHigh">Low - High</label>
                            </div>
                        </form>
                    </div>
                    <!-- Sorting End -->
                </div>
                <!-- Shop Sidebar End -->


                <!-- Shop Product Start -->
                <div class="col-md-10">
                    <div class="container">
                        <div class="row pb-3" id="productCardRow">
                            <% productData.forEach((product,index)=>{ %>
                            <div class="col-lg-4 col-md-6 col-sm-6 pb-1">
                                <div class="card product-item mb-4 product-card shadow">
                                    <a href="/productDetail/<%= product._id %>" class="product-outline">
                                        <div class="card-header product-img position-relative overflow-hidden  p-0">
                                            <img class="img-fluid product-image w-100" src=" /static/images/ProductImages/<%= product.images[0] %>" alt="">
                                            <div class="position-absolute" style="top: 8px; right: 50px; z-index: 1;">
                                                <i class="fa-regular fa-heart wish-btn"></i>
                                            </div>
                                            <div class="position-absolute" style="top: 5px; right: 5px; z-index: 1;">
                                                <span class="badge">New</span>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <h6 class="text-truncate product-name tet-center mb-3"><%= product.name %></h6>
                                            <div class="d-flex align-items-end">
                                                <h6 class="offer-price">₹<%= product.offerPrice %></h6>
                                                <h6 class="real-price small mx-3">₹<del class="real-price"><%= product.realPrice %></del></h6>
                                            </div>
                                        </div>
                                    </a>
                                    <button class="card-footer d-flex justify-content-center bg-light border">
                                        <a href="" class="btn btn-sm text-dark p-0">
                                            <i class="fas fa-shopping-cart text-primary mr-1"></i>Add To Cart
                                        </a>
                                    </button>
                                </div>
                            </div>
                            <% } ) %>
                        </div>

                        <% if(productData != ""){ %>
                            <div class="col-12 pb-1">
                                <nav aria-label="Page navigation">
                                    <ul class="pagination justify-content-center mb-3">
                                        <li class="page-item disabled">
                                            <a class="page-link" href="#" aria-label="Previous">
                                                <span aria-hidden="true">&laquo;</span>
                                                <span class="sr-only">Previous</span>
                                            </a>
                                        </li>
                                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                                        <li class="page-item">
                                            <a class="page-link" href="#" aria-label="Next">
                                                <span aria-hidden="true">&raquo;</span>
                                                <span class="sr-only">Next</span>
                                            </a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                            <% }else{ %>
                                <div class="alert alert-info text-center" role="alert">No products found in the database.</div>
                            <% } %>
                    </div>
                </div>
                <!-- Shop Product End -->
            </div>
        </div>
        <!-- Shop End -->

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

        <script>
            ////// Function to open and close the small device filter dropdown \\\\\\
            $(document).ready(function () {
                $('.filter-toggle-btn').click(function () {
                    $('.filter-list').toggleClass('open');
                });
            });

            ////// Function to add id's of the category checkbox \\\\\\
            let selectedCategories = new Set();
            let selectedBrands = new Set();
            function handleCheckboxChange(checkbox) {
                const categoryId = checkbox.getAttribute("data-category-id");
                const brandId = checkbox.getAttribute("data-brand-id");

                if (checkbox.checked) {
                    selectedCategories.add(categoryId);
                    selectedBrands.add(brandId);
                } else {
                    selectedCategories.delete(categoryId);
                    selectedBrands.delete(brandId);
                }

                updateProductList();
            }
            console.log("Selected categories :",selectedCategories)
            console.log("Selected brands :",selectedBrands)

            ////// Function to fetch the categorized products and show it dynamically \\\\\\
            function updateProductList() {
                fetch('/shopCategoryId', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ categories: [...selectedCategories], brands: [...selectedBrands] })
                })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    let productData = data.productData
                    ////// Emptying the child elements of the productCardRow div \\\\\\
                    $("#productCardRow").empty()
                    
                    productData.forEach((product) => {
                        const productDiv = $(
                            `<div class='col-lg-4 col-md-6 col-sm-6 pb-1'>
                                <div class='card product-item mb-4 product-card shadow'>
                                    <a href='/productDetail/${product._id}' class='product-outline'>
                                        <div class='card-header product-img position-relative overflow-hidden  p-0'>
                                            <img class='img-fluid product-image w-100' src='/static/images/ProductImages/${product.images[0]}' alt=''>
                                            <div class='position-absolute' style='top: 8px; right: 50px; z-index: 1;'>
                                                <i class='fa-regular fa-heart wish-btn'></i>
                                            </div>
                                            <div class='position-absolute' style='top: 5px; right: 5px; z-index: 1;'>
                                                <span class='badge'>New</span>
                                            </div>
                                        </div>
                                        <div class='card-body'>
                                            <h6 class='text-truncate product-name text-center mb-3'>${product.name}</h6>
                                            <div class='d-flex align-items-end'>
                                                <h6 class='offer-price'>₹${product.offerPrice}</h6>
                                                <h6 class='real-price small mx-3'>₹<del class='real-price'>${product.realPrice}</del></h6>
                                            </div>
                                        </div>
                                    </a>
                                        <button class='card-footer d-flex justify-content-center bg-light border'>
                                            <a href='' class='btn btn-sm text-dark p-0'>
                                                <i class='fas fa-shopping-cart text-primary mr-1'></i>
                                                Add To Cart
                                            </a>
                                        </button>
                                    </div>
                                </div>`
                        );
                        ////// Appending the dynamically created product card in to the productCardRow div \\\\\\
                        $("#productCardRow").append(productDiv)
                    });
                    ////// if the productData's length is 0 in response , then redirecting to shop page \\\\\\
                    if(productData.length == 0){
                        Swal.fire({
                            title: "No Products Found",
                            text: "No products were found for the selected filters.",
                            icon: "info",
                            timer: 2000,
                            timerProgressBar: true,
                            showConfirmButton: false
                        }).then(()=>{
                            window.location.href ='/shop'
                        })
                    }
                })
                .catch(error => {
                    console.error('Error fetching products:', error);
                });
            }
        </script>

    </section>

    <!-- User footer -->
    <%-include("../userpartials/footer.ejs")%>