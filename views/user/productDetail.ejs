<!-- User navbar -->
<%-include("../userpartials/Navbar.ejs")%>

    <head>
        <!-- Custom css -->
        <link rel="stylesheet" href="/static/css/product_Detail.css">

        <style>
            #second{
                background-size: 600%;   
                background-repeat: no-repeat;
                background-position: center;
                display: none;
            }

            #lens{
                width: 100px;
                height: 100px;
                background: rgba(0,0,0,.4);
                position: absolute;
                border: 3px solid black;
                transform:  translateY(-50% , -50%);
                pointer-events: none;
                display: none;
            }

            .product-image .first { /* Add this class to the first carousel item */
                position: relative; /* Enable relative positioning for lens */
            }
        </style>
        
    </head>

    <section class="view">
        <!-- Shop Detail Start -->
        <div class="container-fluid mt-5 d-flex flex-row justify-content-center ">
            <% if(productData !="" ){ %>
                <div class="container mt-5 row d-flex justify-content-center">
                    <div class="col-md-2 shadow p-4 side-img d-none d-xl-block" style="height: 400px; overflow-y: scroll;">
                        <% productData.images.forEach((image, index)=> { %>
                            <div class="each-img m-3" data-img-id="<%= image %>" data-index="<%= index %>" onclick="changeimage(this)">
                                <img class="w-100" src="/static/images/ProductImages/<%= image %>" alt="Image">
                            </div>
                        <% }) %>
                    </div>
                    <div class="col-md-5 product-image">
                        <div id="carouselExampleAutoplaying" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-inner shadow">
                                <% productData.images.forEach((image, index) => { %>
                                    <div id="carousel-item-<%= index %>" class="carousel-item <%= index === 0 ? 'active' : '' %> first">
                                        <span id="lens"></span>
                                        <img class="w-100" src="/static/images/ProductImages/<%= image %>" alt="Image" data-selected="<%= index === 0 ? 'true' : 'false' %>" id="target-image">
                                    </div>
                                <% }); %>
                            </div>
                            <button class="carousel-control-prev" type="button" id="carousel-btnOne"
                                data-bs-target="#carouselExampleAutoplaying" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" id="carousel-btnTwo"
                                data-bs-target="#carouselExampleAutoplaying" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        </div>
                    </div>

                    <div class="col-5 shadow" id="second">
                    </div>

                    

                    <div class="col-md-5 d-flex flex-column mt-4 mt-md-0" id="product-detail">
                        <h3 class="font-weight-semi-bold product-name">
                            <%= productData.brand.name %>
                                <%= productData.name %>
                        </h3>
                        <h6 class="product-desc col-lg-10">
                            <%= productData.description %>
                        </h6>
                        <div class="d-flex align-items-end my-lg-auto">
                            <h5 class="discount-perc">
                                -<%= productData.discountPercentage %>%
                                    <span class="off small">Off</span>
                            </h5>
                            <h4 class="offer-price mx-3">
                                ₹<%= productData.offerPrice %>
                            </h4>
                        </div>
                        <h6 class="text-muted">
                            M.R.P <del class="real-price">₹<%= productData.realPrice %></del>
                        </h6>
                        <div class="product-extra-details my-lg-auto">
                            <p class="mb-2"><span class="extra-detail-span">Colors :</span>
                                <span class="mx-3">
                                    <%= productData.colour %>
                                </span>
                            </p>
                            <p class="mb-2"><span class="extra-detail-span">Category :</span>
                                <span class="mx-3">
                                    <%= productData.category.name %>
                                </span>
                            </p>
                            <p class="mb-2">
                                <span class="extra-detail-span">In stock :</span>
                                <% if(productData.noOfStock < 10){ %>
                                    <span class="mx-3 text-danger">
                                        <%= productData.noOfStock %> <span class="hurry-up">Hurry up</span>
                                    </span>
                                <% }else{ %>
                                    <span class="mx-3 text-success">
                                        <%= productData.noOfStock %>
                                    </span>
                                <% } %>
                            </p>
                        </div>
                        <div class="d-flex align-items-center my-lg-auto">
                            <button class="btn addtocart-btn px-3 shadow d-none d-lg-block"
                                data-prod-id="<%= productData._id %>" onclick="addToCart(this)"><i
                                    class="fa fa-shopping-cart mr-1"></i> Add tocart</button>
                            <button class="btn addtocart-btn px-3 btn-sm shadow d-block d-lg-none"
                                data-prod-id="<%= productData._id %>" onclick="addToCart(this)"><i
                                    class="fa fa-shopping-cart mr-1"></i> Add tocart</button>
                            <button class="btn buynow-btn px-3 mx-3 shadow d-none d-lg-block"><i
                                    class="fa fa-bag-shopping mr-1"></i> Buy Now</button>
                            <button class="btn buynow-btn px-3 mx-3 btn-sm shadow d-block d-lg-none"><i
                                    class="fa fa-bag-shopping mr-1"></i> Buy Now</button>
                        </div>
                    </div>
                </div>
                <% }else{ %>
                    <h3 class="text-center bg-warning">No Product found</h3>
            <% } %>
        </div>
        <!-- Shop Detail End -->


        <!-- Products Start -->
        <div class="container-fluid py-5 mt-5">
            <div class="text-center mb-4">
                <h2 class="section-title px-5"><span class="px-2">Same category products</span></h2>
            </div>
            <section class="bg-light mt-2" id="sectiontwo">
                <div class="col-12">
                    <div class="scroll-container">
                        <div class="d-flex overflow-auto p-2">
                            <% if(sameCategoryProduct !="" ){ %>
                                <% sameCategoryProduct.forEach((product , index)=>{ %>
                                    <a href="/productDetail/<%= product._id %>" class="product-outline">
                                        <div class="box-two mx-2 text-center border-0" style="flex: 0 0 auto;">
                                            <div class="img">
                                                <img src="/static/images/ProductImages/<%= product.images[0] %>"
                                                    alt="No image">
                                            </div>
                                            <div class="name">
                                                <h5>
                                                    <%= product.name %>
                                                </h5>
                                            </div>
                                            <div class="offer">
                                                <h6>Min <%= product.discountPercentage %> off</h6>
                                            </div>
                                        </div>
                                    </a>
                                <% }) %>
                            <% }else{ %>
                                <h3 class="text-center bg-warning">No same category Product found</h3>
                            <% } %>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        <!-- Products End -->

        <!-- JQuery cdn -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <!-- Script for sweet alert -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

        <script>

         ////// Funciton to add product to cart \\\\\\
         function addToCart(element) {
            const productId = element.getAttribute('data-prod-id');
            console.log('Product ID:', productId);

            fetch('/addProductToCartFromShop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ productId: productId })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log("data :", data);
                if (data.redirectUrl) {
                    window.location.href = data.redirectUrl;
                } else if (data.success) {
                    Swal.fire({
                        title: "Success",
                        text: data.message,
                        icon: "success",
                        timer: 2000,
                        timerProgressBar: true,
                        showConfirmButton: false
                    }).then(data =>{
                        location.reload()
                    })
                } else if (data.status === 409) {
                    Swal.fire({
                        title: "Info",
                        text: data.message,
                        icon: "info",
                        timer: 2000,
                        timerProgressBar: true,
                        showConfirmButton: false
                    })
                } else {
                    Swal.fire({
                        title: "Error",
                        text: data.message,
                        icon: "error",
                        timer: 2000,
                        timerProgressBar: true,
                        showConfirmButton: false
                    });
                }
            })
            .catch(error => {
                console.log("error :", error)
                Swal.fire({
                    title: "Error",
                    text: "Internal server error.",
                    icon: "error",
                    timer: 2000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            });
        }

        ////// function to show the selected imag \\\\\\
        function changeimage(element) {
            var imgSrc = element.getAttribute("data-img-id");
            var index = parseInt(element.getAttribute("data-index"));

            document.querySelectorAll('.carousel-item').forEach(item => {
                item.classList.remove('active');
            });

            var carouselItem = document.getElementById(`carousel-item-${index}`);
            if (carouselItem) {
                carouselItem.classList.add('active');
            }

            // var targetImage = document.getElementById("target-image");
            // targetImage.src = `/static/images/ProductImages/${imgSrc}`; 
        }

        // for showing image in zoom div
        document.addEventListener('DOMContentLoaded', function() {
            var targetImage = document.getElementById("target-image");
            var second = document.getElementById("second")
            if (targetImage) {
                console.log("src of target:", targetImage.src);
                var targetSrc = targetImage.src
                second.style.backgroundImage = `url(${targetSrc})` 
            } else {
                console.error("Element with id 'target-image' not found in the document.");
            }
        });

        var lens = document.getElementById("lens")
        var first = document.querySelector(".first")
        var second = document.getElementById("second")
        var productDetail = document.getElementById("product-detail")
        var carouselButtonOne = document.getElementById("carousel-btnOne")
        var carouselButtonTwo = document.getElementById("carousel-btnTwo")
        console.log("producrDetail :",productDetail)

        first.addEventListener("mousemove",function(e){
            var x = e.clientX - e.target.offsetLeft;
            var y = e.clientY - e.target.offsetTop;

            lens.style.left = x - 400 + "px"
            lens.style.top = y - 170 + "px"

            var lensX = x - 400;
            var lensY = y - 170; 

            second.style.backgroundPosition = -lensX * 6 + 'px ' + -lensY * 8 + 'px';

        })

        first.addEventListener("mouseenter", function() {
            carouselButtonOne.style.display = "none"
            carouselButtonTwo.style.display = "none"
            second.style.display = "block"
            lens.style.display = "block";
            productDetail.classList.add("d-none")
        });

        first.addEventListener("mouseleave", function() {
            carouselButtonOne.style.display = "block"
            carouselButtonTwo.style.display = "block"
            second.style.display = "none"
            lens.style.display = "none";
            productDetail.classList.remove("d-none")
        });
        </script>

    </section>

    <!-- User footer -->
    <%-include("../userpartials/footer.ejs")%>