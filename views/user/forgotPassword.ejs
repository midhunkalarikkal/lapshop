<!-- User navbar -->
<%-include("../userpartials/Navbar.ejs")%>

<head>
    <!-- User login page css -->
    <link rel='stylesheet' href='/static/css/user_login_register.css' type="text/css" />
</head>

<div id="screen-size"></div>
<section class="view">
    <div class="container input-box">
        <div class="form-box col-12 col-md-6 col-lg-4" id="form-box-one">
            <header class="my-4 fs-4 title text-center">Verify email</header>
            <form action="/login" method="post">
                <div class="input-field">
                    <input type="text" class="input" id="email" name="email" onblur="validateEmail()" required>
                    <label for="email">Email</label>
                </div>
                <div class="input-field">
                    <input type="text" class="input" id="otp" name="otp" required>
                    <label for="otp">Otp</label>    
                </div>
                <div class="input-field">
                    <button type="button" class="btn" id="submit">Get otp</button>
                    <button type="button" class="btn" id="fpOtpVerify" style="display: none;">Verify</button>
                </div>
            </form>
            <div class="signin mb-2">
                <span id="timer"></span>
            </div>
        </div>

        <!-- Second form start -->
        <div class="form-box col-12 col-md-6 col-lg-4" id="form-box-two" style="display: none;">
            <header class="my-4 fs-4 title text-center">Reset password</header>
            <form action="/login" method="post">
                <div class="input-field">
                    <input type="text" class="input" id="newPass" name="newPass" required>
                    <label for="newPass">New password</label>
                </div>
                <div class="input-field">
                    <input type="text" class="input" id="confirmPass" name="confirmPass" required>
                    <label for="confirmPass">Re-enter password</label>
                </div>
                <div class="input-field">
                    <button type="button" class="btn" id="submitPassword">Save</button>
                </div>
            </form>
        </div>
        <!-- Second form end -->
    </div>
</section>

<!--  Validation script for login form -->
<script src=""></script>

 <!-- Script to post the user information data -->
 <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>

    //To send the otp to email
    document.getElementById('submit').addEventListener('click', async function (event) {
        event.preventDefault();
        let email = document.getElementById('email').value;

    const formData = {
        email: email
    };

    try {
        const response = await fetch('/fpassPostEmail', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        if (response.ok) {

            Swal.fire({
                title: 'OTP Sent',
                text: 'An OTP has been sent to your email.',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false,
            });
            
            document.getElementById("submit").style.display = "none";
            document.getElementById("fpOtpVerify").style.display = "block"; 
        
            
            let timeLeft = 10;
            const timerElement = document.getElementById('timer');
            timerElement.style.display = "block"
            const timerInterval = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerElement.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                timeLeft--;
                if(timeLeft < 10){
                    timerElement.style.color = "red"
                }
                
                if (timeLeft < 0) {
                    clearInterval(timerInterval);
                    document.getElementById("submit").innerText = "Resend OTP";
                    document.getElementById("submit").style.display = "block";
                    document.getElementById("fpOtpVerify").style.display = "none";
                    timerElement.innerText = "00:00";
                    timerElement.style.display = "none"
                    timerElement.style.color = "white"
                }
            }, 1000);
        } else {
            const responseData = await response.json();
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: responseData.message,
                timer: 2000, 
                timerProgressBar: true, 
                showConfirmButton: false 
            });
            
        }
    } catch (error) {
        console.error('Error:', error);
    }
});

// To verify the otp
document.getElementById('fpOtpVerify').addEventListener('click', async function (event) {
    event.preventDefault();

    const otp = document.getElementById('otp').value;
    const formData = { otp };

    try {
        const response = await fetch('/fpassPostOtp', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        if (response.ok) {
            const responseData = await response.json();
            Swal.fire({
                title: 'OTP Sent',
                text: responseData.message,
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false,
            });
            document.getElementById('form-box-one').style.display = "none"
            document.getElementById('form-box-two').style.display = "block"
        } else {
            const responseData = await response.json();
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: responseData.message,
                timer: 2000, 
                timerProgressBar: true, 
                showConfirmButton: false 
            });
        }
    } catch (error) {
        console.error('Error:', error);
    }
});

// To submit the passwords from seconf form
document.getElementById('submitPassword').addEventListener('click', async function (event) {
    event.preventDefault();

    const newPassword = document.getElementById('newPass').value;
    const confirmPassword = document.getElementById('confirmPass').value;

    if (newPassword !== confirmPassword) {
        Swal.fire({
            icon: 'error',
            title: 'Password Mismatch',
            text: 'The passwords are not matching.',
            timer: 2000,
            timerProgressBar: true,
            showConfirmButton: false,
        });
        return;
    }

    const formData = { newPassword: newPassword };
    console.log(formData);

    try {
        const response = await fetch('/fpassPostPassword', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        if (response.ok) {
            const responseData = await response.json();
            Swal.fire({
                icon: 'success',
                title: 'User password',
                text: responseData.message,
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false,
            }).then(() => {
                window.location.replace('/login');
            });
        } else {
            const responseData = await response.json();
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: responseData.message,
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
        }
    } catch (error) {
        console.error('Error:', error);
    }
});
</script>

<!-- User footer -->
 <%-include("../userpartials/footer.ejs")%>