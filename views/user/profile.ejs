<!-- User navbar -->
<%-include("../userpartials/navbar.ejs")%>

    <head>
        <!-- custom css for user profile -->
        <link rel='stylesheet' href='/static/css/profile.css' type="text/css" />
    </head>

    <section class="view">
        <div class="container mt-3 py-3 h-100">
            <div class="row d-flex justify-content-center">
                <div class="col-10 col-md-12 col-lg-10 mb-4 mb-lg-0 mt-lg-5">
                    <div class="heading">
                        <h2>Your profile details</h2>
                    </div>
                    <hr>
                    <div class="card mb-3 shadow" style="border-radius: .5rem;">
                        <div class="row g-0">
                            <% if(userData !="" ){ %>
                                <div class="col-md-4 gradient-custom text-center text-white d-flex flex-column align-items-center">
                                    <% if(userData.profileimage ) { %>
                                        <img src="../../static/images/UserProfile/<%= userData.profileimage %>" alt="Avatar" class="img-fluid mt-5 my-3 " style="width: 150px; height: 150px;" />
                                    <% }else{ %>
                                        <img src="../../static/images/icons/No profile image.jpg" alt="Avatar" class="img-fluid mt-5 my-3 " style="width: 150px; height: 150px;" />
                                    <% } %>
                                    <div class="name-date mt-2">
                                        <h5>Hi, <span> <%= userData.fullname %> </span></h5>
                                    </div>  
                                    <div class="extra-btns d-flex flex-column my-auto d-none d-md-block" style="width: 75%;">
                                        <% if(userData.profileimage ) { %>
                                            <a data-bs-toggle="modal" data-bs-target="#profileImageModal" class="prf-btn">
                                                <div class="extra-btn p-1 mb-1 d-flex align-items-center justify-content-center" style="border: 1px solid black;">
                                                    <div class="col-4 d-flex justify-content-end">
                                                        <i class="fas fa-upload"></i>
                                                    </div>
                                                    <div class="col-8 d-flex justify-content-start mx-2 btn-text">
                                                        Update image
                                                    </div>
                                                </div>
                                            </a>
                                        <% }else{ %>
                                            <a data-bs-toggle="modal" data-bs-target="#profileImageModal" class="prf-btn">
                                                <div class="extra-btn p-1 mb-1 d-flex align-items-center justify-content-center" style="border: 1px solid black;">
                                                    <div class="col-4 d-flex justify-content-end">
                                                        <i class="fas fa-upload"></i>
                                                    </div>
                                                    <div class="col-8 d-flex justify-content-start mx-2 btn-text">
                                                        Upload image
                                                    </div>
                                                </div>
                                            </a>       
                                        <% } %>
                                        <a data-bs-toggle="modal" data-bs-target="#verifyModal" class="prf-btn">
                                            <div class="extra-btn p-1 mb-1 d-flex align-items-center justify-content-center" style="border: 1px solid black;">
                                                <div class="col-4 d-flex justify-content-end">
                                                    <i class="fas fa-lock"></i>
                                                </div>
                                                <div class="col-8 d-flex justify-content-start mx-2 btn-text">
                                                    Password
                                                </div>
                                            </div>
                                        </a>
                                        <a href="/cart">
                                            <div class="extra-btn p-1 mb-1 d-flex align-items-center justify-content-center" style="border: 1px solid black;">
                                                <div class="col-4 d-flex justify-content-end">
                                                    <i class="fas fa-cart-shopping"></i>
                                                </div>
                                                <div class="col-8 d-flex justify-content-start mx-2 btn-text">
                                                    Your cart
                                                </div>
                                            </div>
                                        </a>
                                        <a href="/wishlist">
                                            <div class="extra-btn p-1 mb-1 d-flex align-items-center justify-content-center" style="border: 1px solid black;">
                                                <div class="col-4 d-flex justify-content-end">
                                                    <i class="fas fa-heart"></i>
                                                </div>
                                                <div class="col-8 d-flex justify-content-start mx-2 btn-text">
                                                    Your wishlist
                                                </div>
                                            </div>
                                        </a>
                                        <a href="/wallet">
                                            <div class="extra-btn p-1 mb-1 d-flex align-items-center justify-content-center" style="border: 1px solid black;">
                                                <div class="col-4 d-flex justify-content-end">
                                                    <i class="fas fa-wallet"></i>
                                                </div>
                                                <div class="col-8 d-flex justify-content-start mx-2 btn-text">
                                                    Your wallet
                                                </div>
                                            </div>
                                        </a>
                                        <a href="/orders">
                                            <div class="extra-btn p-1 mb-1 d-flex align-items-center justify-content-center" style="border: 1px solid black;">
                                                <div class="col-4 d-flex justify-content-end">
                                                    <i class="fas fa-boxes-stacked"></i>
                                                </div>
                                                <div class="col-8 d-flex justify-content-start mx-2 btn-text">
                                                    Your orders
                                                </div>
                                            </div>
                                        </a>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="card-body p-4">
                                        <div class="row pt-1">
                                            <div class="col-12 d-flex align-items-center">
                                                <div class="edit-btn col-4">
                                                    <h5 class="m-0">Information</h5>
                                                </div>
                                                <div class="edit-btn col-8 d-flex justify-content-end">
                                                    <button class="btn btn-secondary btn-sm mb-2" data-bs-toggle="modal" data-bs-target="#informationModal">
                                                        <i class="fas fa-edit"></i> Edit
                                                    </button>
                                                </div>
                                            </div>
                                            <hr>
                                            <div class="col-12 d-flex">
                                                <p class="col-4 fw-semibold">Name</p>
                                                <p class="text-muted col-8"> <%= userData.fullname %></p>
                                            </div>
                                            <hr>
                                            <div class="col-12 d-flex">
                                                <p class="col-4 fw-semibold">Email</p>
                                                <p class="text-muted col-8"> <%= userData.email %> </p>
                                            </div>
                                            <hr>
                                            <div class="col-12 d-flex">
                                                <p class="col-4 fw-semibold">Phone</p>
                                                <p class="text-muted col-8"> <%= userData.phone %> </p>
                                            </div>
                                            <hr>
                                            <div class="col-12 d-flex">
                                                <p class="col-4 fw-semibold">Joined on</p>
                                                <p class="text-muted col-8"> <%= formattedDate %> </p>
                                            </div>
                                            <hr>
                                            <div class="col-12 d-flex">
                                                <p class="col-4 fw-semibold">Referal code</p>
                                                <p class="text-muted col-4" id="referralCode"><%= userData.referalCode %></p>
                                                <p onclick="copyReferal()" style="cursor: pointer;"><i class="fa-solid fa-copy" style="color: black;"></i> <span id="referalCopyBtn">COPY REFERAL</span></p>
                                            </div>
                                            <hr>
                                        </div>
                                        
                                        <div class="row pt-1 address.container">
                                            <div class="col-12 d-flex align-items-center">
                                                <div class="edit-btn col-4">
                                                    <h5 class="m-0">Address</h5>
                                                </div>
                                                <div class="edit-btn col-8 d-flex justify-content-end">
                                                    <button 
                                                        class="btn btn-secondary btn-sm mb-2"
                                                        id="add-address"
                                                        data-userId="<%= userData._id %>">
                                                        <i class="fas fa-add"></i> Add address
                                                    </button>
                                                </div>
                                            </div>
                                            <hr>
                                            <% if(address && address.length> 0){ %>
                                                <% address.forEach((address,index)=> {%>
                                                    <div class="col-12 d-flex">
                                                        <p class="col-4 fw-semibold">Address <%= index+1 %> </p>
                                                        <div class="address text-muted col-8">
                                                            <p>
                                                                <%= address.name %>, 
                                                                <%= address.addressLine%>,
                                                                <span>Phone : </span>
                                                                <%= address.phone%>,
                                                                <%= address.city%>, 
                                                                <span>Pincode : </span>
                                                                <%= address.pincode%>, 
                                                                <%= address.district%>,
                                                                <%= address.state%>, 
                                                                <%= address.country%>
                                                            </p>
                                                            <div class="buttons d-flex justify-content-start">
                                                                <button 
                                                                    class="btn btn-secondary btn-sm edit-address-btn mb-1"
                                                                    data-adId="<%= address._id %>" ><i
                                                                    class="fas fa-edit"></i>
                                                                </button>
                                                                <button
                                                                    class="btn btn-danger btn-sm delete-address-btn mb-1 mx-2"
                                                                    data-adid="<%= address._id %>"><i
                                                                    class="fas fa-trash"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <hr>
                                                <% }) %>
                                            <% }else{ %>
                                                <p class="text-muted">No addresses found.</p>
                                            <% } %>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4 p-3 gradient-custom text-center text-white d-flex flex-column align-items-center d-block d-md-none">
                                        <div class="extra-btns d-flex flex-column my-auto" style="width: 75%;">
                                            
                                                <% if(userData.profileimage ) { %>
                                                    <a data-bs-toggle="modal" data-bs-target="#profileImageModal" class="prf-btn">
                                                        <div class="extra-btn p-1 mb-1 d-flex align-items-center justify-content-center" style="border: 1px solid black;">
                                                            <div class="col-4 d-flex justify-content-end">
                                                                <i class="fas fa-upload"></i>
                                                            </div>
                                                            <div class="col-8 d-flex justify-content-start mx-2 btn-text">
                                                                Update image
                                                            </div>
                                                        </div>
                                                    </a>
                                                <% }else{ %>
                                                    <a data-bs-toggle="modal" data-bs-target="#profileImageModal" class="prf-btn">
                                                        <div class="extra-btn p-1 mb-1 d-flex align-items-center justify-content-center" style="border: 1px solid black;">
                                                            <div class="col-4 d-flex justify-content-end">
                                                                <i class="fas fa-upload"></i>
                                                            </div>
                                                            <div class="col-8 d-flex justify-content-start mx-2 btn-text">
                                                                Upload image
                                                            </div>
                                                        </div>
                                                    </a>       
                                                <% } %>
                                                <a data-bs-toggle="modal" data-bs-target="#verifyModal" class="prf-btn">
                                                    <div class="extra-btn p-1 mb-1 d-flex align-items-center justify-content-center" style="border: 1px solid black;">
                                                        <div class="col-4 d-flex justify-content-end">
                                                            <i class="fas fa-lock"></i>
                                                        </div>
                                                        <div class="col-8 d-flex justify-content-start mx-2 btn-text">
                                                            Password
                                                        </div>
                                                    </div>
                                                </a>
                                                <a href="/cart">
                                                    <div class="extra-btn p-1 mb-1 d-flex align-items-center justify-content-center" style="border: 1px solid black;">
                                                        <div class="col-4 d-flex justify-content-end">
                                                            <i class="fas fa-cart-shopping"></i>
                                                        </div>
                                                        <div class="col-8 d-flex justify-content-start mx-2 btn-text">
                                                            Your cart
                                                        </div>
                                                    </div>
                                                </a>
                                                <a href="/wishlist">
                                                    <div class="extra-btn p-1 mb-1 d-flex align-items-center justify-content-center" style="border: 1px solid black;">
                                                        <div class="col-4 d-flex justify-content-end">
                                                            <i class="fas fa-heart"></i>
                                                        </div>
                                                        <div class="col-8 d-flex justify-content-start mx-2 btn-text">
                                                            Your wishlist
                                                        </div>
                                                    </div>
                                                </a>
                                                <a href="/wallet">
                                                    <div class="extra-btn p-1 mb-1 d-flex align-items-center justify-content-center" style="border: 1px solid black;">
                                                        <div class="col-4 d-flex justify-content-end">
                                                            <i class="fas fa-wallet"></i>
                                                        </div>
                                                        <div class="col-8 d-flex justify-content-start mx-2 btn-text">
                                                            Your wallet
                                                        </div>
                                                    </div>
                                                </a>
                                                <a href="/orders">
                                                    <div class="extra-btn p-1 mb-1 d-flex align-items-center justify-content-center" style="border: 1px solid black;">
                                                        <div class="col-4 d-flex justify-content-end">
                                                            <i class="fas fa-boxes-stacked"></i>
                                                        </div>
                                                        <div class="col-8 d-flex justify-content-start mx-2 btn-text">
                                                            Your orders
                                                        </div>
                                                    </div>
                                                </a>

                                        </div>
                                    </div>

                                </div>
                            <% }else{ %>
                                <div class="alert alert-info text-center" role="alert">No Userdata found in the database.</div>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- User info Modal start -->
    <div class="modal fade" id="informationModal" tabindex="-1" aria-labelledby="informationModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="informationModalLabel">Edit user information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="userInfoForm">
                        <% if(userData !="" ){ %>
                            <div class="mb-3">
                                <label for="userName" class="form-label">Username</label>
                                <input type="text" class="form-control" id="userName" name="userName" value="<%= userData.fullname %>" oninput="validateName()">
                                <span id="nameError" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label for="phone" class="form-label">Phone no</label>
                                <input type="number" class="form-control" id="phone" name="phone" value="<%= userData.phone %>" oninput="validatePhone()">
                                <span id="phoneError" class="text-danger"></span>
                            </div>
                            <div class="mb-3" style="display: none;">
                                <label for="userId" class="form-label">User id</label>
                                <input type="text" class="form-control" id="userId" name="userId" value="<%= userData._id %>">
                            </div>
                        <% } %>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" id="saveUserInfo" class="btn btn-success">Save</button>
                </div>
            </div>
        </div>
    </div>
    <!-- User info Modal end -->

    <!-- User image Modal start -->
    <div class="modal fade" id="profileImageModal" tabindex="-1" aria-labelledby="profileImageModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="profileImageModalLabel">Profile image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="userImageForm">
                        <div class="mb-3">
                            <label for="image" class="form-label mx-2">Select image</label>
                            <input type="file" name="image" id="image" class="form-control form-control-md" onchange="previewImage()">
                        </div>
                        <div class="mb-3 text-center">
                            <div class="image">
                                <img id="preview" class="thumbnail img-fluid" src="" alt="" style="width: 150px; height: auto;">
                            </div>
                        </div>
                        <div class="mb-3" style="display: none;">
                            <label for="userId" class="form-label">User id</label>
                            <input type="text" class="form-control" id="userIdFromImage" name="userId" value="<%= userData._id %>">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="saveUserImage" class="btn btn-success">Save</button>
                </div>
            </div>
        </div>
    </div>
    <!-- User image Modal end -->

    <!-- User email verification for change password Modal start -->
    <div class="modal fade" id="verifyModal" tabindex="-1" aria-labelledby="verifyModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="verifyModalLabel">Verify email</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="emailVerifyForm">
                        <% if(userData !="" ){ %>
                            <div class="mb-3">
                                <label for="userName" class="form-label">Enter your email</label>
                                <input type="email" class="form-control" id="email" name="email" required oninput="validateEmail()">
                                <span id="emailError" class="text-danger"></span>
                            </div>
                            <div class="mb-3 d-none" id="otp-input">
                                <label for="passotp" class="form-label">Enter Otp</label>
                                <input type="text" class="form-control" id="passotp" name="passotp" required>
                            </div>
                            <div class="mb-3" style="display: none;">
                                <label for="userId" class="form-label">User id</label>
                                <input type="text" class="form-control" id="userId" name="userId" value="<%= userData._id %>">
                            </div>
                            <div class="mb-3" style="display: none;">
                                <label for="userEmail" class="form-label">User email</label>
                                <input type="text" class="form-control" id="userEmail" name="userEmail" value="<%= userData.email %>">
                            </div>
                        <% } %>
                    </form>
                    <span id="timer" style="margin-left: auto;"></span>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="sendOtp">Send Otp</button>
                    <button type="submit" id="submitOtp" class="btn btn-success" disabled>Submit</button>
                </div>
            </div>
        </div>
    </div>
    <!-- User email verification for change password Modal end -->

    <!-- User change password Modal start -->
    <div class="modal fade" id="passModal" tabindex="-1" aria-labelledby="passModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="passModalLabel">Verify email</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="passwordForm">
                        <% if(userData !="" ){ %>
                            <div class="mb-3">
                                <label for="newPass" class="form-label">New password</label>
                                <input type="text" class="form-control" id="newPass" name="newPass" required>
                            </div>
                            <div class="mb-3">
                                <label for="confirmPass" class="form-label">Confirm password</label>
                                <input type="text" class="form-control" id="confirmPass" name="confirmPass" required>
                            </div>
                            <div class="mb-3" style="display: none;">
                                <label for="userId" class="form-label" >User id</label>
                                <input type="text" class="form-control" id="userId" name="userId" value="<%= userData._id %>">
                            </div>
                        <% } %>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" id="submitPass" class="btn btn-success">Submit</button>
                </div>
            </div>
        </div>
    </div>
    <!-- User change password Modal end -->

    <!-- script for the sweet alert -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>

        ////// To copy the referal code \\\\\\
        function copyReferal() {
            const referralCodeElement = document.getElementById('referralCode');
            const btn = document.getElementById('referalCopyBtn')
            const referralCode = referralCodeElement.textContent;
            navigator.clipboard.writeText(referralCode)
            .then(() => {
                btn.innerHTML = "COPIED";
                setTimeout(function () {
                    btn.innerHTML = "COPY REFERRAL";
                }, 3000);
            })
            .catch((error) => {
                Swal.fire({
                    icon: 'info',
                    title: 'Copy Failed',
                    text: 'Failed to copy the code. Please try again.',
                    timer: 3000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            });
        }

        ////// Function to handle image preview \\\\\\
        function previewImage() {
            const preview = document.getElementById('preview');
            const file = document.getElementById('image').files[0];
            const reader = new FileReader();

            reader.onloadend = function () {
                preview.src = reader.result;
            };

            if (file) {
                reader.readAsDataURL(file);
            } else {
                preview.src = "../../static/images/icons/No profile image.jpg";
            }
        }

         ////// Validation function for name input \\\\\\
         function validateName() {
                const nameInput = document.getElementById('userName');
                const name = nameInput.value.trim();
                const nameError = document.getElementById('nameError');

                const namePattern = /^[a-zA-Z][a-zA-Z\s]*[a-zA-Z]$/;

                if (name === "") {
                    nameInput.classList.remove('is-invalid');
                    nameError.textContent = '';
                    return false;
                }
                if (!namePattern.test(name)) {
                    nameInput.classList.add('is-invalid');
                    nameError.textContent = 'Name must contain only alphabets and spaces.';
                    return false;
                } else if (name.length < 5 || name.length > 25) {
                    nameInput.classList.add('is-invalid');
                    nameError.textContent = 'Name must be between 5 and 25 characters long';
                    return false;
                } else {
                    nameInput.classList.remove('is-invalid');
                    nameError.textContent = '';
                    return true;
                }
            }

            ////// Validation function for phone input \\\\\\
            function validatePhone() {
                const phoneInput = document.getElementById('phone');
                const phone = phoneInput.value.trim();
                const phoneError = document.getElementById('phoneError');

                const phonePattern = /^\d{10}$/;

                if (phone === "") {
                    phoneInput.classList.remove('is-invalid');
                    phoneError.textContent = '';
                    return false;
                }
                if (!phonePattern.test(phone)) {
                    phoneInput.classList.add('is-invalid');
                    phoneError.textContent = 'Phone number must contain only 10 digits.';
                    return false;
                } else {
                    phoneInput.classList.remove('is-invalid');
                    phoneError.textContent = '';
                    return true;
                }
            }

            ////// Validation function for phone input \\\\\\
            function validateEmail() {
            const emailInput = document.getElementById("email");
            const email = emailInput.value;
            const emailError = document.getElementById('emailError');

            var emailRegex = /^[^\s@]+@gmail\.com$/;

            if (email === "") {
                emailInput.classList.remove('is-invalid');
                emailError.textContent = '';
                return false;
            }
            if (!emailRegex.test(email)) {
                emailInput.classList.add('is-invalid');
                emailError.textContent = 'Phone check the email.';
                return false;
            } else {
                emailInput.classList.remove('is-invalid');
                emailError.textContent = '';
                return true;
            }
        }


        ////// To update the user information \\\\\\
        document.getElementById('saveUserInfo').addEventListener('click', async function () {
            const formData = {
                userName: document.getElementById('userName').value,
                phone: document.getElementById('phone').value,
                userId: document.getElementById('userId').value
            };

            if(!validateName() || !validatePhone()){
                swal.fire({
                    icon: "warning",
                    title: "Invalid info",
                    text: "Please check the fields.",
                    showConfirmButton: true,
                    confirmButtonText: "Ok"
                })
                return false
            }            

            try {
                const response = await fetch('/updateUserInfo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Success!',
                            text: data.message || 'User updated successfully',
                            showConfirmButton: true,
                            confirmButtonText: "Ok"
                        }).then((result) => {
                            if (result.isConfirmed) {
                                $('#informationModal').modal('hide');
                                location.reload();
                            }
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error!',
                            text: data.message || 'Failed to update user information',
                            timer: 3000,
                            timerProgressBar: true,
                            showConfirmButton: false
                        });
                    }
                } else {
                    window.location.href = `/login`;
                    return;
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'Internal server error',
                    timer: 3000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            }
        });

        ////// Function to handle image upload \\\\\\
        document.getElementById('saveUserImage').addEventListener('click', async function () {
            const userProfileImageInput = document.getElementById("image").files[0];
            const userId = document.getElementById('userIdFromImage').value;

            if (!userProfileImageInput) {
                Swal.fire({
                    icon: 'info',
                    title: 'Profile image',
                    text: 'Please select an image',
                    showConfirmButton: true,
                    confirmButtonText: "Ok"       
                });
                return;
            }

            const formData = new FormData();
            formData.append('profileImg', userProfileImageInput);
            formData.append('userId', userId);

            try {
                const response = await fetch('/uploadProfileImage', {
                    method: 'POST',
                    body: formData
                });

                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Success!',
                            text: data.message || 'Profile image uploaded successfully',
                            showConfirmButton: true,
                            confirmButtonText: "Ok"
                        }).then((result) => {
                            if (result.isConfirmed) {
                                $('#profileImageModal').modal('hide');
                                location.reload();
                            }
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error!',
                            text: data.message || 'Failed to upload profile image',
                            timer: 3000,
                            timerProgressBar: true,
                            showConfirmButton: false
                        });
                    }
                } else {
                    window.location.href = `/login`;
                    return;
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'Internal server error',
                    timer: 3000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            }
        });


        ////// To delete a specific address \\\\\\
        document.querySelectorAll('.delete-address-btn').forEach(button => {
            button.addEventListener('click', async function () {
                const addressId = this.dataset.adid;

                const confirmResult = await Swal.fire({
                    icon: 'warning',
                    title: 'Are you sure?',
                    text: 'You are about to delete this address.',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, delete it'
                });

                if (confirmResult.isConfirmed) {
                    try {
                        const response = await fetch(`/deleteAddress/${addressId}`, {
                            method: 'DELETE'
                        });
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const data = await response.json();
                            if(data.success){
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success!',
                                    text: data.message || 'Address deleted successfully.',
                                    showConfirmButton: true,
                                    confirmButtonText: 'OK'
                                }).then((result)=>{
                                    if(result.isConfirmed){
                                        location.reload();
                                    }
                                })
                            }else{
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success!',
                                    text: data.message || 'Address deletion failed.',
                                    timer: 3000,
                                    timerProgressBar: true,
                                    showConfirmButton: false
                                })
                            }
                        }else{
                            window.location.href = '/login'
                            return;
                        }
                    } catch (error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error!',
                            text: error.message || 'Failed to delete address',
                            timer: 3000,
                            timerProgressBar: true,
                            showConfirmButton: false
                        });
                    }
                }
            });
        });

        ////// To add a new address \\\\\\
        document.getElementById('add-address').addEventListener('click', function () {
            const userId = this.dataset.userid;
            window.location.href = `/addAddress/${userId}`; 
        });    
        

        ////// To edit a specific address \\\\\\
        document.querySelectorAll('.edit-address-btn').forEach(button => {
            button.addEventListener('click', function () {
            const addressId = this.dataset.adid;
            window.location.href = `/editAddress/${addressId}`; 
            });
        });

        ////// To send otp to email for changing password \\\\
        document.getElementById('sendOtp').addEventListener('click', async function (event) {
            event.preventDefault();

            const email = document.getElementById('email').value;
            const userId = document.getElementById('userId').value;
            const userEmail = document.getElementById('userEmail').value;

            if(!validateEmail()){
                Swal.fire({
                    icon: 'warning',
                    title: 'Incorrect eamil!',
                    text: 'Please check the email..',
                    showConfirmButton: true,
                    confirmButtonText: "Ok"
                });
                return;
            }

            if(email !== userEmail){
                Swal.fire({
                    icon: 'info',
                    title: 'Eamil!',
                    text: 'Entered email is not registered.',
                    showConfirmButton: true,
                    confirmButtonText: "Ok"
                });
                return;
            }

            const formData = {
                email: email
            };

            try {
                const response = await fetch('/sendOtpForPass', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'OTP Sent!',
                            text: data.message || 'OTP sent successfully.',
                            timer: 3000,
                            timerProgressBar: true,
                            showConfirmButton: false
                        });

                        document.getElementById("submitOtp").disabled = false;
                        document.getElementById("sendOtp").disabled = true;
                        document.getElementById("otp-input").classList.remove("d-none")
                        document.getElementById("otp-input").classList.add("d-block")

                        let timeLeft = 180;
                        const timerElement = document.getElementById('timer');
                        const timerInterval = setInterval(() => {
                            const minutes = Math.floor(timeLeft / 60);
                            const seconds = timeLeft % 60;
                            timerElement.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                            timeLeft--;
                            if (timeLeft < 30) {
                                timerElement.style.color = "red";
                            }

                            if (timeLeft < 0) {
                                clearInterval(timerInterval);
                                document.getElementById("sendOtp").disabled = false;
                                document.getElementById("submitOtp").disabled = true;
                                document.getElementById("sendOtp").innerText = "Resend OTP";
                                document.getElementById("otp-input").classList.remove("d-block")
                                document.getElementById("otp-input").classList.add("d-none")
                                timerElement.innerText = "00:00";
                                timerElement.style.color = "black";
                            }
                        }, 1000);
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error!',
                            text: data.message || 'Failed to send OTP',
                            timer: 3000,
                            timerProgressBar: true,
                            showConfirmButton: false
                        });
                    }
                }else{
                    window.location.href = `/login`;
                    return;
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'Internal server error.',
                    timer: 3000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            }
        });

        ////// For submiting otp \\\\\\
        document.getElementById('submitOtp').addEventListener('click', async function () {
            const formData = {
                otp: document.getElementById('passotp').value,
            };

            try {
                const response = await fetch('/submitOtp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    if (data.success) {
                        Swal.fire({
                            icon: "success",
                            title: "Otp verified",
                            text: data.message || "Opt verified successfully.",
                            timer: 3000,
                            timerProgressBar: true,
                            showConfirmButton: false
                        }).then(()=>{
                            $('#verifyModal').modal('hide');
                            $('#passModal').modal('show');
                        })
                    } else {
                        Swal.fire({
                            icon: "error",
                            title: "Invalid OTP",
                            text: data.message || "Entered OTP is incorrect",
                            timer: 3000,
                            timerProgressBar: true,
                            showConfirmButton: false
                        });
                    }
                } else {
                    window.location.href = `/login`;
                    return;
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'Network error. Please try again.',
                    timer: 3000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            }
        });

        ////// For submiting the new password \\\\\\
        document.getElementById('submitPass').addEventListener('click', async function (event) {
            event.preventDefault();

            const newPass = document.getElementById('newPass').value;
            const confirmPass = document.getElementById('confirmPass').value;
            const userId = document.getElementById('userId').value;

            if (newPass !== confirmPass) {
                Swal.fire({
                    icon: 'info',
                    title: 'Password!',
                    text: 'Password is not matching.',
                    showConfirmButton: true,
                    confirmButtonText: "Ok"
                });
                return;
            }

            const formData = {
                newPass: newPass,
                userId: userId
            };

            try {
                const response = await fetch('/updatePassword', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                })
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Password',
                            text: data.message || 'Password changed successfully.',
                            showConfirmButton: true,
                            confirmButtonText: "Ok"
                        }).then((result) => {
                            if (result.isConfirmed) {
                                $('#passModal').modal('hide');
                            }
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Failed!',
                            text: data.message || 'Password update failed, please try again.',
                            timer: 3000,
                            timerProgressBar: true,
                            showConfirmButton: false
                        });
                    }
                } else {
                    window.location.href = `/login`;
                    return;
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'Internal server error.',
                    timer: 3000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            }
        });

    </script>

    <!-- User footer -->
    <%-include("../userpartials/footer.ejs")%>