<%-include("../adminpartials/admin_navbar.ejs")%>
    <div class="container mt-5">
        <div class="row" style="background-color: rgb(255, 255, 255);">
            <div class="head col-md-10 offset-md-1 d-flex justify-content-between align-items-center">
                <h1>Categories</h1>
                <button type="button" class="btn btn-outline-success btn-sm" data-bs-toggle="modal" data-bs-target="#exampleModal">
                    Add new category
                  </button>
            </div>
        </div>
        <div class="row d-flex flex-row align-items-center justify-content-center">
            <div class="table-responsive col-8">
                <% if(category !=""){ %>
                <table class="table text-center my-4">
                    <thead>
                        <tr>
                            <th class="text-center text-dark">Nos</th>
                            <th class="text-center text-dark">Category</th>
                            <th class="text-center text-dark">Controls</th>
                            <th class="text-center text-dark">Options</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% category.forEach((row,index) => { %>
                        <tr class="align-middle">
                            <td>
                                <%= index+1 %>
                            </td>
                            <td>
                                <%= row.name %>
                            </td>
                            <td>
                                <input type="radio" class="category-switch" data-category-id="<%= row._id %>" id="block_<%= row._id %>" name="block<%= row._id %>" value="block" <% if(row.isBlocked) { %>checked<% } %>>
                                <label for="block_<%= row._id %>" class="text-danger">Block</label>
                                <input type="radio" class="category-switch" data-category-id="<%= row._id %>" id="unblock_<%= row._id %>" name="block<%= row._id %>" value="unblock" <% if(!row.isBlocked) { %>checked<% } %>>
                                <label for="unblock_<%= row._id %>" class="text-success">Unblock</label>                
                            </td>
                            <td>
                                <a href="" class="text-success"><i
                                    class="fas fa-edit fa-lg mx-1"></i></a>
                                <a href="" class="text-danger"><i
                                    class="fas fa-trash fa-lg mx-1"></i></a>
                            </td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
                <% } else {%>
                    <div class="alert alert-info text-center" role="alert">
                        No categories found in the database.
                    </div>
                    <% } %>   
            </div>
        </div>
    </div>

    <!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Add New Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="mb-3">
              <label for="categoryName" class="form-label">Category Name</label>
              <input type="text" class="form-control" id="categoryName" name="categoryName">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" id="save" class="btn btn-primary">Save</button>
        </div>
      </div>
    </div>
  </div>



        <script>

            //to send the categoryname to adminController
            document.getElementById("save").addEventListener("click", async function() {
    const categoryName = document.getElementById("categoryName").value;

    try {
        const response = await fetch("/admin/addCategory", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ categoryName: categoryName })
        });

        if (response.ok) {
            const data = await response.json();
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: data.message
            }).then(() => {
                $('#exampleModal').modal('hide');
            });
        } else if (response.status === 400) {
            const errorData = await response.json();
            Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: errorData.error
            });
        } else {
            // Handle other error cases
            Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: 'An unexpected error occurred. Please try again.'
            });
        }
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: 'Network error. Please try again.'
        });
    }
});

//For blocking and unblocking the category

document.querySelectorAll('.category-switch').forEach(function(userSwitch) {
    userSwitch.addEventListener('change', function () {
        var categoryId = this.dataset.categoryId;
        var blockStatus = this.value;

        // Confirm the action with a modal dialog
        Swal.fire({
            title: 'Confirmation',
            text: 'Are you sure you want to change the block status?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes'
        }).then((result) => {
            if (result.isConfirmed) {
                // Send a POST request to the server
                fetch(`/admin/categoryblock${categoryId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ blockStatus: blockStatus })
                })
                .then(response => {
                    // Check if the response is successful
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Failed to update cattegory block status.');
                    }
                })
                .then(data => {
                    // Handle the response data
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Category block status has been updated.'
                    });
                    updateRadioButtons(categoryId, blockStatus);
                })
                .catch(error => {
                    // Handle errors
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: error.message
                    });
                });
            } else {
                // Action cancelled
                location.reload();
            }
        });
    });
});


        function updateRadioButtons(categoryId, blockStatus) {
            const blockRadio = document.getElementById(`block_${categoryId}`);
            const unblockRadio = document.getElementById(`unblock_${categoryId}`);

            if (blockStatus === 'block') {
                blockRadio.checked = true;
                unblockRadio.checked = false;
            } else {
                blockRadio.checked = false;
                unblockRadio.checked = true;
            }
        }

        </script>

        <%-include("../adminpartials/admin_footer.ejs")%>